# Copyright (c) 2020 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# See: https://sipb.mit.edu/doc/safe-shell/
#
#
# A devfile to develpop che-theia projects on https://che.openshift.io.
# For developers who work on Theia or Che-Theia extensions and plugins.

apiVersion: 1.0.0

metadata:
  name: theia-dogfooding
  
projects:
  - name: theia
    source:
      location: 'https://github.com/eclipse-theia/theia.git'
      type: git
      branch: master

  - name: che-theia
    source:
      location: 'https://github.com/eclipse/che-theia.git'
      type: git
      branch: master

components:
  # - id: eclipse/che-theia/latest
  #   memoryLimit: 1500M
  #   type: cheEditor
  #   alias: theia-editor

  # Temporary switched to using latest version of Che-Theia
  # Will be removed after updating hosted Che with Che-Theia 7.9.0 or newer.
  - 
    memoryLimit: 1500M
    type: cheEditor
    reference: >-
      https://raw.githubusercontent.com/eclipse/che-plugin-registry/master/v3/plugins/eclipse/che-theia/next/meta.yaml
    alias: theia-editor

  - id: che-incubator/typescript/latest
    memoryLimit: 2048M
    type: chePlugin

  - id: redhat/vscode-yaml/latest
    type: chePlugin

  - id: eclipse/che-machine-exec-plugin/latest
    type: chePlugin

  - mountSources: true
    endpoints:
      - name: theia-dev-flow
        port: 3010
        attributes:
          protocol: http
          public: 'true'
    memoryLimit: 3Gi
    type: dockerimage
    alias: che-dev
    image: 'quay.io/eclipse/che-theia-dev:next'

commands:
  - name: '1. Rsync sources'
    actions:
      - workdir: /projects
        type: exec
        command: |
          echo -e '\e[32mRsyncing theia sources to /tmp/theia...\e[0m'; \
          mkdir -p /tmp/theia/che/che-theia; \
          rsync -rtv --exclude='node_mobules' /projects/theia/ /tmp/theia/; \
          rsync -rtv --exclude='node_mobules' /projects/che-theia/ /tmp/theia/che/che-theia/; \
          echo -e '\e[32mDone\e[0m'
        component: che-dev

  - name: '2. Init che:theia'
    actions:
      - workdir: /tmp/theia
        type: exec
        command: |
          echo -e '\e[32mInitializing che-theia...\e[0m'; \
          che:theia init --alias https://github.com/eclipse/che-theia=/tmp/theia/che/che-theia; \
          echo -e '\e[32mDone\e[0m'
        component: che-dev

  - name: '3. Build che:theia'
    actions:
      - workdir: /tmp/theia
        type: exec
        command: |
          echo -e '\e[32mBuilding che-theia...\e[0m'; \
          yarn; \
          echo -e '\e[32mDone\e[0m'
        component: che-dev

  - name: '4.1. Prepare theia-* dirs'
    actions:
      - workdir: /projects
        type: exec
        command: |
          echo -e '\e[32mPreparing theia-* dirs...\e[0m'; \
          mkdir /projects/theia-default-plugins; \
          mkdir /projects/theia-plugins; \
          mkdir /projects/theia-projects-dir; \
          cd /default-theia-plugins; \
          cp * /projects/theia-default-plugins/; \
          echo -e '\e[32mDone\e[0m'
        component: theia-editor

  - name: '4.2. Launch'
    actions:
      - workdir: /tmp/theia/examples/assembly
        type: exec
        command: |
          echo -e '\e[32mLaunching che-theia...\e[0m'; \
          export CHE_PROJECTS_ROOT="/projects/theia-projects-dir"; \
          export THEIA_DEFAULT_PLUGINS="local-dir:///projects/theia-default-plugins"; \
          export THEIA_PLUGINS="local-dir:///projects/theia-plugins"; \
          export THEIA_PLUGIN_ENDPOINT_DISCOVERY_PORT="2506"; \
          yarn theia start /projects/theia-projects-dir --hostname=0.0.0.0 --port=3010; \
          echo -e '\e[32mDone\e[0m'
        component: che-dev
